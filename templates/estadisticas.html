<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Estad칤sticas de Emociones</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
</head>
<body class="bg-gradient-to-r from-gray-800 to-teal-500 text-white min-h-screen flex flex-col items-center justify-center p-8">

    <div class="bg-white bg-opacity-10 p-6 rounded-lg shadow-lg w-full max-w-3xl">
        <h1 class="text-2xl font-bold text-center mb-4">游늵 Tus Estad칤sticas Emocionales</h1>

        <!-- Selector de Filtro -->
        <form method="get" action="{{ url_for('estadisticas') }}" class="mb-6 flex justify-center">
            <label for="filtro" class="mr-3 text-lg font-bold text-white bg-gradient-to-r from-teal-400 to-cyan-600 px-3 py-1 rounded-full shadow-md">
                游댌 Filtrar por:
            </label>
            <select name="filtro" id="filtro" onchange="this.form.submit()"
            class="bg-white text-gray-800 font-semibold px-4 py-2 rounded-lg shadow-lg border border-gray-300 hover:border-teal-500 focus:outline-none focus:ring-2 focus:ring-teal-400 transition duration-200 ease-in-out">
                <option value="dia" {% if filtro == 'dia' %}selected{% endif %}>游늰 Hoy</option>
                <option value="semana" {% if filtro == 'semana' %}selected{% endif %}>游딉 칔ltimos 7 d칤as</option>
                <option value="15dias" {% if filtro == '15dias' %}selected{% endif %}>游딉 칔ltimos 15 d칤as</option>
                <option value="mes" {% if filtro == 'mes' %}selected{% endif %}>游늱 칔ltimos 30 d칤as</option>
            </select>
        </form>

        <!-- Gr치fica -->
        <canvas id="emocionesChart" class="mb-6"></canvas>

        <!-- Bot칩n para descargar PDF -->
        <button onclick="generarPDF()" 
            class="bg-gradient-to-r from-green-500 to-blue-500 text-white py-2 px-4 mb-4 rounded-lg shadow-md transition-transform transform hover:scale-105">
            游늯 Descargar Reporte en PDF
        </button>

        <!-- Bot칩n volver -->
        <a href="{{ url_for('detectar') }}" class="bg-gradient-to-r from-red-500 to-teal-500 text-white py-2 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105">
            游 Volver al Inicio
        </a>
    </div>

    <!-- Script para mostrar gr치fica -->
    <script>
        try {
            const emociones = JSON.parse('{{ emociones | tojson | safe }}');
            const totales = JSON.parse('{{ totales | tojson | safe }}');

            if (emociones.length === 0 || totales.length === 0) {
                console.warn("No hay datos para mostrar en la gr치fica.");
            } else {
                const ctx = document.getElementById('emocionesChart').getContext('2d');
                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: emociones,
                        datasets: [{
                            label: 'Cantidad de veces detectada',
                            data: totales,
                            backgroundColor: [
                                '#f87171', '#34d399', '#60a5fa', '#fbbf24', '#a78bfa', '#f472b6'
                            ],
                            borderColor: '#fff',
                            borderWidth: 2,
                            borderRadius: 6,
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: { color: 'white' }
                            },
                            x: {
                                ticks: { color: 'white' }
                            }
                        },
                        plugins: {
                            legend: {
                                labels: { color: 'white' }
                            },
                            title: {
                                display: true,
                                text: 'Frecuencia de Emociones Detectadas',
                                color: 'white',
                                font: { size: 18 }
                            }
                        }
                    }
                });
            }
        } catch (e) {
            console.error("Error al generar la gr치fica:", e);
        }
    </script>

    <!-- Script para generar PDF -->
    <script>
        async function generarPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
    
            // Datos del usuario
            const nombre = "{{ session['nombre'] }}";
            const correo = "{{ session['correo'] }}";
            const fecha = new Date().toLocaleDateString();
    
            // Logo (opcional)
            const logoUrl = "/static/media/LOGOMINDVIBE.png";
    
            // T칤tulo del reporte
            doc.setFontSize(20);
            doc.setTextColor(40, 40, 40);
            doc.text("Reporte de Estad칤sticas Emocionales", 105, 20, null, null, 'center');
    
            // Informaci칩n del usuario
            doc.setFontSize(12);
            doc.text(`Nombre del Usuario: ${nombre}`, 20, 40);
            doc.text(`Correo Electr칩nico: ${correo}`, 20, 48);
            doc.text(`Fecha del Reporte: ${fecha}`, 20, 56);
    
            // Descripci칩n
 // Descripci칩n en un solo p치rrafo bien formateado
 const descripcion = "Este reporte muestra el an치lisis emocional basado en las detecciones durante el periodo seleccionado. A continuaci칩n se visualiza un gr치fico de barras representando la frecuencia con la que se detect칩 cada emoci칩n.";
        
        doc.setFontSize(12);
        doc.text(descripcion, 20, 70, {
            maxWidth: 170,  // Ancho m치ximo para que el texto no salga de la p치gina
            align: 'left'
        });
    
            // L칤nea separadora
            doc.setDrawColor(200);
            doc.line(20, 85, 190, 85);
    
            // Subt칤tulo
            doc.setFontSize(14);
            doc.text("Frecuencia de Emociones Detectadas", 20, 95);
    
            // Captura de la gr치fica
            const canvas = document.getElementById('emocionesChart');
            const image = await html2canvas(canvas);
            const imgData = image.toDataURL('image/png');
    
            // Imagen de la gr치fica
            doc.addImage(imgData, 'PNG', 20, 100, 170, 80);
    
            // Lista de emociones (opcional)
            const emociones = JSON.parse('{{ emociones | tojson | safe }}');
            doc.setFontSize(12);
            doc.text("Emociones detectadas:", 20, 190);
            
            let yPosition = 200;
            emociones.forEach(emocion => {
                doc.text(`- ${emocion}`, 25, yPosition);
                yPosition += 7;
            });
    
            // Guardar
            doc.save(`Reporte_Emocional_${nombre}.pdf`);
        }
    </script>
    
</body>
</html>